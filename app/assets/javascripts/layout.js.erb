$(function() {

	/* SLIDER */
	initialize_slider();
	function initialize_slider() {
		var header_width = slider_header_width();
		var slide_width = slider_slide_width();
		
		$("#slider article").removeAttr("style");
		$("#slider article").removeClass("collapsed");
		$("#slider article").removeClass("active");
		$("#slider article").first().addClass("active");
		$("#slider article:not(.active)").addClass("collapsed");
		$("#slider article.active").show();
		// set the width of the slider content
		$("#slider article").css("width", slide_width + "%");
		// display all of the collapsed article headers at the correct distance apart
		$("#slider article.collapsed").show();
		$("#slider article.collapsed").css("width", header_width + "px");
		$("#slider article.collapsed").each(function(i) {			
			$(this).css("right", (header_width * (i)) + "px");
		});
	}

	var slider_interval = 2000;
	var reset = false;
	var timer = setInterval(function() {
		if(reset == true) {
			initialize_slider();
			reset = false;
		}
		else {
			var header_width = slider_header_width();
			var $active = $("#slider article.active");
			var $next = $active.next();
			// make next slide active
			$next.addClass("active");
			$next.removeClass("collapsed");
			$next.css("border-right", "1px solid #000000");
			$next.animate({
				width: slider_slide_width() + "%"
			}, 800, function() {
				// make current slide inactive
				$active.removeClass("active");
				$active.addClass("collapsed");
				$active.show();
				$active.css("width", header_width);
				$next.css("border", "none");
			});
			//$next.css("width", slider_slide_width() + "%");
			// update all slides positions
			var active_slide = active_slide_position();
			var num_slides = $("#slider article").length;
			$("#slider article").each(function(i) {
				// if the slide is before the active slide
				if(i <= active_slide) {
					// set its left position
					$(this).css("left", (header_width*i) + "px");
				}
				else {
					// set its right position
					$(this).css("right", (header_width*(num_slides - (i+1))) + "px");
				}
			});

			// if we get to the last slide, start again
			if((active_slide_position() + 1) == num_slides) {
				console.log("done");
				reset = true;
			}
		}
	}, slider_interval);

	function active_slide_position() {
		var active_slide_position;
		$("#slider article").each(function(i) {
			if($(this).hasClass("active")) {
				active_slide_position = i;
			}
		});
		return active_slide_position;
	}

	function slider_header_width() {
		return $("#slider article header").outerWidth(true);
	}

	function slider_slide_width() {
		var header_width = slider_header_width();
		var num_slides = $("#slider article").length;	
		var container_width = $("#slider").outerWidth(true);
		var slide_width = (container_width - ((num_slides - 1) * header_width)) / container_width * 100;
		return slide_width;
	}

	/* NAVIGATION LINKS */
	$("#main-nav li a.active");

	$("#home-link").hover(function() {
		$li = $(this);
		$img = $(this).find("img");
		if(!$li.hasClass("active")) {
			$img.attr("src", "/assets/home-active.png");
		}
	}, function() {
		if(!$li.hasClass("active")) {		
			$img.attr("src", "/assets/home.png");			
		}
	});

	$("#main-nav li a").hover(function() {
		$(this).closest("li").addClass("hover");
	}, function() {
		$(this).closest("li").removeClass("hover");
	});

	$(document).pjax("#services a.btn", "#main-content");

	$("#services a.btn").click(function() {
		$("#main-content").css("opacity", "0.3");
		$("body").append("<div id='spinner'></img>")

		$("#spinner").css("top", $("#main-content").offset().top + 100);
		$("#spinner").css("left", $("#main-content").offset().left + ($("#main-content").width() / 2) - 60);
		$('html, body').animate({
			scrollTop: $("#main-content").offset().top
		}, 800);		
	});

	$(document).on("pjax:success", function(xhr, data){
		$("#main-content").html(data);
		$("#main-content").css("opacity", "1");
		$("#spinner").remove();
	});
});